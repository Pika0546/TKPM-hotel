{{#section 'head'}}
  <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Cập nhật phiếu thuê phòng</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Google Fonts
		============================================ -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,700,900" rel="stylesheet">
    <!-- Bootstrap CSS
		============================================ -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <!-- Bootstrap CSS
		============================================ -->
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <!-- owl.carousel CSS
		============================================ -->
    <link rel="stylesheet" href="/css/owl.carousel.css">
    <link rel="stylesheet" href="/css/owl.theme.css">
    <link rel="stylesheet" href="/css/owl.transitions.css">
    <!-- animate CSS
		============================================ -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- normalize CSS
		============================================ -->
    <link rel="stylesheet" href="/css/normalize.css">
    <!-- meanmenu icon CSS
		============================================ -->
    <link rel="stylesheet" href="/css/meanmenu.min.css">
    <!-- main CSS
		============================================ -->
    <link rel="stylesheet" href="/css/main.css">
    <!-- modals CSS
		============================================ -->
    <link rel="stylesheet" href="/css/modals.css">
    <!-- educate icon CSS
		============================================ -->
    <link rel="stylesheet" href="/css/educate-custon-icon.css">
    <!-- morrisjs CSS
		============================================ -->
    <link rel="stylesheet" href="/css/morrisjs/morris.css">
    <!-- mCustomScrollbar CSS
		============================================ -->
    <link rel="stylesheet" href="/css/scrollbar/jquery.mCustomScrollbar.min.css">
    <!-- metisMenu CSS
		============================================ -->
    <link rel="stylesheet" href="/css/metisMenu/metisMenu.min.css">
    <link rel="stylesheet" href="/css/metisMenu/metisMenu-vertical.css">
    <!-- datapicker CSS
		============================================ -->
    <link rel="stylesheet" href="/css/datapicker/datepicker3.css">
    <!-- calendar CSS
		============================================ -->
    <link rel="stylesheet" href="/css/calendar/fullcalendar.min.css">
    <link rel="stylesheet" href="/css/calendar/fullcalendar.print.min.css">
    <!-- forms CSS
		============================================ -->
    <link rel="stylesheet" href="/css/form/all-type-forms.css">
	 <link rel="stylesheet" href="/css/alerts.css">
    <!-- style CSS
		============================================ -->
    <link rel="stylesheet" href="/style.css">
    <!-- responsive CSS
		============================================ -->
    <link rel="stylesheet" href="/css/responsive.css">
    <!-- bonus CSS
		============================================ -->
    <link rel="stylesheet" href="/css/my-css.css">
    <!-- modernizr JS
		============================================ -->
    <script src="/js/vendor/modernizr-2.8.3.min.js"></script>
{{/section}}

<div class="container-fluid mg-b-15" style="display: flex; flex-direction:column;  width: 100%;">
  <div class="product-payment-inner-st">
    <ul id="myTabedu1" class="tab-review-design">
      <li class="active"><a href="#description">Tình trạng thuê phòng</a></li>
    </ul>
  </div>
  <div class="my-search-row">
		<div class="row" style="position: relative;">
			<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
        <label id="cur-room" class="login2">Phòng: 101</label>
      </div>
      <div class="col-lg-2 col-md-3 col-sm-3 col-xs-12">
        <label class="login2 pull-right pull-right-pro" id="time">Ngày thuê: 22/04/2022</label>
      </div>
      <div class="col-lg-4 col-md-3 col-sm-3 col-xs-12">
            <div class="add-product add-customer">
                
                <a id="add-guest-a" href="" data-toggle="modal" data-target="#add-guest-modal" style="top: -3px;">Thêm khách</a>{{!-- <a id="add-guest-a" href="" data-toggle="modal" data-target="#add-guest-modal" style="top: -3px;">Thêm khách</a> --}}
            </div>
        </div>
        <div class="add-product add-customer">
			<a href="/bill/add?room={{roomrentId}}" style="top: -3px;">Trả phòng</a>
		</div>
    </div>
  </div>
		<div class="product-status-wrap" style="flex: 1 1 auto; display:flex; flex-direction:column;">
			<div class="asset-inner" style="flex: 1 1 auto;">
				<table>
					<thead>
						<tr>
							<th>STT</th>
							<th>Khách hàng</th>
							<th>Loại khách</th>
							<th>CMND/CCCD</th>
              <th>Địa chỉ</th>
							<th>Hành động</th>
						</tr>
					</thead>
					<tbody id="table-body" style="padding-bottom: 100px !important">
            {{#each guests}}
            <tr>
								<td>{{this.stt}}</td>
										<td>{{this.fullname}}</td>
										<td>{{this.typeName}}</td>
										<td>{{this.identityNumber}}</td>
										<td>{{this.address}}</td>
										<td>
											<button data-id="{{this.id}}" data-toggle="modal" data-target="#update-guest-modal" title="Cập nhật" class="pd-setting-ed"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></button>
											<button data-id="{{this.id}}" title="Xóa" class="pd-setting-ed button-del" data-toggle="modal" data-target="#delete-guest-modal"><i class="fa fa-trash-o" aria-hidden="true"></i></button>
										</td>
							</tr>
            {{/each}}
					</tbody>
				</table>
			</div>
			<div  id="delete-guest-modal" class="modal modal-edu-general FullColor-popup-DangerModal fade" role="dialog">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-close-area modal-close-df">
							<a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
						</div>
						<div class="modal-body">
							<span class="educate-icon educate-danger modal-check-pro information-icon-pro"></span>
							<h2 id="modal-text">Xóa khách này?</h2>
							<!-- <p>If you delete this product, they can not access the shop's website anymore.</p> -->
						</div>
						<div class="modal-footer danger-md">
							<button class="btn btn-danger " type="button" data-dismiss="modal">Hủy</button>
							<form method="post" style="display: none;" id="delete-room-form"></form>
							<button class="btn btn-danger" id="delete-guest-btn" type="button" data-dismiss="modal">Xóa</button>
						</div>
					</div>
				</div>
			</div>
            <div  id="add-guest-modal" class="modal modal-edu-general default-popup-PrimaryModal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header header-color-modal bg-color-1" style="padding: 15px;">
                            <h4 class="modal-title" style="margin-bottom: 0; color: white">Thêm khách</h4>
                            <div class="modal-close-area modal-close-df">
                                <a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 0; text-align: left">
                            <div style="padding: 20px; background-color: white;">
                                <div class="row">
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <div class="form-group">
                                            <label for="add-guest-name">Họ tên khách hàng:</label>
                                            <input id="add-guest-name" name="guestName" type="text" class="form-control" required maxlength="255" placeholder="Họ tên">
                                        </div>
                                        <div class="form-group">
                                            <label for="add-guest-type">Loại khách:</label>
                                            <select id="guest-type-select" class="form-control" name="guestType">
                                              {{#each guestType}}
													                      <option value="{{this.id}}">{{this.typeName}}</option>
												                      {{/each}}
								            </select>
                                        </div>  
                                        <div class="form-group">
                                            <label for="add-guest-id">CMND/CCCD:</label>
                                            <input id="add-guest-id" name="guestId" type="text" class="form-control" required maxlength="255" placeholder="CMND/CCCD">
                                        </div>
                                        <div class="form-group">
                                            <label for="add-guest-address">Địa chỉ:</label>
                                            <input id="add-guest-address" name="guestAddress" type="text" class="form-control" required maxlength="255" placeholder="Địa chỉ">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary waves-effect waves-light" type="button" data-dismiss="modal">Hủy</button>
                            <button class="btn btn-primary waves-effect waves-light" type="button" id="add-guest-btn">Thêm</button>
                        </div>
                    </div>
                </div>
            </div>
            <div  id="update-guest-modal" class="modal modal-edu-general default-popup-PrimaryModal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header header-color-modal bg-color-1" style="padding: 15px;">
                            <h4 class="modal-title" style="margin-bottom: 0; color: white">Cập nhật thông tin khách</h4>
                            <div class="modal-close-area modal-close-df">
                                <a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 0; text-align: left">
                            <div style="padding: 20px; background-color: white;">
                                <div class="row">
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <div class="form-group">
                                            <label for="update-guest-name">Họ tên khách hàng:</label>
                                            <input id="update-guest-name" name="guestName" type="text" class="form-control" required maxlength="255" placeholder="Họ tên" value="Lê Văn A">
                                        </div>
                                        <div class="form-group">
                                            <label for="update-guest-type">Loại khách:</label>
                                            <select id="update-type-select" class="form-control" name="guestType">
										                          {{#each guestType}}
													                      <option value="{{this.id}}">{{this.typeName}}</option>
												                      {{/each}}
								                            </select>
                                        </div>  
                                        <div class="form-group">
                                            <label for="update-guest-id">CMND/CCCD:</label>
                                            <input id="update-guest-id" name="guestId" type="text" class="form-control" required maxlength="255" placeholder="CMND/CCCD" value="1234567890">
                                        </div>
                                        <div class="form-group">
                                            <label for="update-guest-address">Địa chỉ:</label>
                                            <input id="update-guest-address" name="guestAddress" type="text" class="form-control" required maxlength="255" placeholder="Địa chỉ" value="TP.HCM">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary waves-effect waves-light" type="button" data-dismiss="modal">Hủy</button>
                            <button class="btn btn-primary waves-effect waves-light" type="button" id="update-guest-btn">Cập nhật</button>
                        </div>
                    </div>
                </div>
            </div>
		</div>
	<div class="row" style="position: relative;">
    	<div class="btn-confirm">
			<a id="capnhat" href="#">Cập nhật</a>
		</div>
	</div>
</div>

{{#section 'script'}}
 <!-- jquery
		============================================ -->
    <script src="/js/vendor/jquery-1.12.4.min.js"></script>
    <!-- bootstrap JS
		============================================ -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- wow JS
		============================================ -->
    <script src="/js/wow.min.js"></script>
    <!-- price-slider JS
		============================================ -->
    <script src="/js/jquery-price-slider.js"></script>
    <!-- meanmenu JS
		============================================ -->
    <script src="/js/jquery.meanmenu.js"></script>
    <!-- owl.carousel JS
		============================================ -->
    <script src="/js/owl.carousel.min.js"></script>
    <!-- sticky JS
		============================================ -->
    <script src="/js/jquery.sticky.js"></script>
    <!-- scrollUp JS
		============================================ -->
    <script src="/js/jquery.scrollUp.min.js"></script>
    <!-- mCustomScrollbar JS
		============================================ -->
    <script src="/js/scrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="/js/scrollbar/mCustomScrollbar-active.js"></script>
    <!-- metisMenu JS
		============================================ -->
    <script src="/js/metisMenu/metisMenu.min.js"></script>
    <script src="/js/metisMenu/metisMenu-active.js"></script>
    <!-- morrisjs JS
		============================================ -->
    <script src="/js/sparkline/jquery.sparkline.min.js"></script>
    <script src="/js/sparkline/jquery.charts-sparkline.js"></script>
    <!-- calendar JS
		============================================ -->
    <script src="/js/calendar/moment.min.js"></script>
    <script src="/js/calendar/fullcalendar.min.js"></script>
    <script src="/js/calendar/fullcalendar-active.js"></script>
    <!-- tab JS
		============================================ -->
    <script src="/js/tab.js"></script>
    <!-- form validate JS
		============================================ -->
    <script src="/js/form-validation/jquery.form.min.js"></script>
    <script src="/js/form-validation/jquery.validate.min.js"></script>
    <script src="/js/form-validation/form-active.js"></script>
    <!-- datapicker JS
		============================================ -->
    <script src="/js/datapicker/bootstrap-datepicker.js"></script>
    <script src="/js/datapicker/datepicker-active.js"></script>
    <!-- tab JS
		============================================ -->
    <script src="/js/tab.js"></script>
    <!-- plugins JS
		============================================ -->
    <script src="/js/plugins.js"></script>
    <!-- main JS
		============================================ -->
    <script src="/js/main.js"></script>
    <!-- tawk chat JS
		============================================ -->
    <!-- <script src="/js/tawk-chat.js"></script> -->
	<!-- MY JAVASCRIPT
		============================================ -->
	<script src="/js/numeral.js"></script>
	<script src="/js/util/generatePager.js"></script>
	<script src="/js/util/ajaxAPI.js"></script>
	<script src="/js/util/queryString.js"></script>
	<script src="/js/util/alert.js"></script>
	<script>
		//
    let index = 0;
    const maximumGuest = {{{json maximumGuest}}};
    let guestType = {{{json guestType}}};
    //console.log("guest type: " + guestTypes);
    const roomrentId = {{{json roomrentId}}}
	let guests = {{{json guests}}}
    let seletedGuest = null;
    let room = {{{json room}}}
	let time = {{{json time}}}
	time = time.substring(0, 10).split("-");

    const displayGuestType = (guestTypeId) => {
			const guestTypeSelected = guestType.filter(type=>type.id === parseInt(guestTypeId));
			return guestTypeSelected[0].typeName;
		}
    // Khach ton tai => trung cccd
		const isExist = (guest) => {
			const guestsById = guests.filter(g=>g.identityNumber === guest.identityNumber);
			return (!guestsById || guestsById.length || false); 
		}

    // check input
    const invalidInput = (guest)=>{
			let message ="";
			const {fullname, typeId, identityNumber, address} = guest;
			if(!fullname || !typeId || !identityNumber || !address){
				message = "Bạn phải điền đầy đủ thông tin vào các trường!";
			}
			else if(Number.isNaN(+identityNumber)){
				message = "CCCD không hợp lệ!";
			}
			return message;
		}

    //reset input sau khi them thanh cong
		const resetInput = ()=>{
			document.getElementById("add-guest-name").value = "";
			$("#guest-type-select").val($("#guest-type-select option:first").val());
			document.getElementById("add-guest-id").value = "";
			document.getElementById("add-guest-address").value = "";
		}

    const handleAddGuest = () => {
			//lấy value từ mấy cái input trong cái form update
			//gán vô 1 con guest
			//const guest = {};
			
			let id = new Date().getMilliseconds();
			let fullname = document.getElementById("add-guest-name").value;
			let typeId = document.getElementById("guest-type-select").value;
			let identityNumber = document.getElementById("add-guest-id").value;
			let address = document.getElementById("add-guest-address").value;
			let guest = {id, fullname, typeId, identityNumber, address, roomrentId};
			
			const message = invalidInput(guest);

			if(message){
				createAlert("error", message);
				document.getElementById("add-guest-btn").removeAttribute("data-dismiss", "modal");
				return;
			}

			if(isExist(guest)){
				createAlert("error", "Khách đã tồn tại trong danh sách!");
				document.getElementById("add-guest-btn").removeAttribute("data-dismiss", "modal");
				return;
			}

			// push nó vô mảng guests
			guests.push(guest);

			//render ra giao diện
			$("#table-body").empty();
			guests.forEach((item, index)=>{
			$("#table-body").append(`<tr>
										<td>${index + 1}</td>
										<td>${item.fullname}</td>
										<td>${displayGuestType(item.typeId)}</td>
										<td>${item.identityNumber}</td>
										<td>${item.address}</td>
										<td>
											<button data-id="${item.id}" data-toggle="modal" data-target="#update-guest-modal" title="Cập nhật" class="pd-setting-ed"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></button>
											<button data-id="${item.id}" title="Xóa" class="pd-setting-ed button-del" data-toggle="modal" data-target="#delete-guest-modal"><i class="fa fa-trash-o" aria-hidden="true"></i></button>
										</td>
									</tr>`)
			})
			createAlert("success", "Thêm khách thành công!");
			resetInput();
			addListenerForDeleteButton();
			document.getElementById("add-guest-btn").setAttribute("data-dismiss", "modal");
		}
    const handleAdda = () => {
			if(guests.length >= parseInt(maximumGuest.value)){
				document.getElementById("add-guest-a").removeAttribute("data-target", "#add-guest-modal");
				createAlert("error", "Số khách đang ở mức tối đa!");
			}
			else{
				document.getElementById("add-guest-a").setAttribute("data-target", "#add-guest-modal");
			}
		}
    const handleUpdateGuest = () => {
			
			//lấy value từ mấy cái input trong cái form update
			//gán vô 1 con guest
			let id = seletedGuest.id;
			let fullname = document.getElementById("update-guest-name").value;
			let typeId = document.getElementById("update-type-select").value;
			let identityNumber = document.getElementById("update-guest-id").value;
			let address = document.getElementById("update-guest-address").value;
			let newGuest = {id, fullname, typeId, identityNumber, address, roomrentId};

			const message = invalidInput(newGuest);
			if(message){
				createAlert("error", message);
				document.getElementById("update-guest-btn").removeAttribute("data-dismiss", "modal");
				return;
			}
			
			//duyệt mảng guests, kiếm id trùng với seletedGuestId rồi update thông tin
			guests = guests.map(g=>{
				if(g.id === seletedGuest.id){
					return newGuest;
				}
				else return g;
			})

			//update giao diện
			$("#table-body").empty();
			guests.forEach((item, index)=>{
			$("#table-body").append(`<tr>
										<td>${index + 1}</td>
										<td>${item.fullname}</td>
										<td>${displayGuestType(item.typeId)}</td>
										<td>${item.identityNumber}</td>
										<td>${item.address}</td>
										<td>
											<button data-id="${item.id}" data-toggle="modal" data-target="#update-guest-modal" title="Cập nhật" class="pd-setting-ed"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></button>
											<button data-id="${item.id}" title="Xóa" class="pd-setting-ed button-del" data-toggle="modal" data-target="#delete-guest-modal"><i class="fa fa-trash-o" aria-hidden="true"></i></button>
										</td>
									</tr>`)
			})
			addListenerForDeleteButton();
			createAlert("success", "Cập nhật khách thành công!");
			document.getElementById("update-guest-btn").setAttribute("data-dismiss", "modal");
		}
    //
    const handleDeleteGuest = () => {
			//duyệt mảng guests, kiếm id trùng với seletedGuestId rồi xóa
			guests = guests.filter((item) => item.id !== parseInt(seletedGuestId));//parseInt()
			//update giao diện
			$("#table-body").empty();
			guests.forEach((item, index)=>{
			$("#table-body").append(`<tr>
										<td>${index + 1}</td>
										<td>${item.fullname}</td>
										<td>${displayGuestType(item.typeId)}</td>
										<td>${item.identityNumber}</td>
										<td>${item.address}</td>
										<td>
											<button data-id="${item.id}" data-toggle="modal" data-target="#update-guest-modal" title="Cập nhật" class="pd-setting-ed"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></button>
											<button data-id="${item.id}" title="Xóa" class="pd-setting-ed button-del" data-toggle="modal" data-target="#delete-guest-modal"><i class="fa fa-trash-o" aria-hidden="true"></i></button>
										</td>
									</tr>`)
			})
			addListenerForDeleteButton();
			createAlert("success", "Xóa khách thành công!");
		}

    const handleUpdateRoomRent = (e) => {
      e.preventDefault();

      if(guests.length === 0){
        createAlert("error", "Danh sách khách trống!");
        return;
      }

      if(guests.length > maximumGuest.value){
        createAlert("error", "Danh sách khách vượt quá số khách tối đa!");
        return;
      }
      
      fetchData('post', {
        {{!-- roomrentId: roomrentId,  --}}
        maximumGuest: maximumGuest.value, 
        room: JSON.stringify(room), 
        guests: JSON.stringify(guests)},
        `/rent/api/update/${roomrentId}`, successCallback, errorCallback)
    }

    const successCallback = (data) => {
      if(!data.success){
        createAlert("error", data.message);
        return;
      }
      else{
        createAlert("success", data.message);
        return;
      }
    }
    const errorCallback = (error) => {
      console.log(error);
      createAlert("error", "Có lỗi xảy ra, vui lòng thử lại!")
    }

	const addListenerForDeleteButton = () => {
		let btnAll = document.querySelectorAll(".button-del");
		//console.log(btnAll);
		for (let i = 0; i < btnAll.length; i++) {
			btnAll[i].addEventListener("click", () => {
				if(btnAll.length <=1 ){
					createAlert("error", "Danh sách khách không được trống!");
					btnAll[i].removeAttribute("data-target", "#delete-guest-modal");
				}
				else{
					btnAll[i].setAttribute("data-target", "#delete-guest-modal");
				}
			})
		}
	}

    $(document).ready(()=>{
      //get message
      const message ={{{json message}}};
			if(message.length > 0){
				console.log("mesage " + message);
				if(!message[0].success){
					createAlert("error", message[0].message);
				}else{
					createAlert("success", message[0].message);
				}
			}
      //
	  addListenerForDeleteButton();
      //add guest event
		document.getElementById("add-guest-btn").addEventListener('click', handleAddGuest);
      document.getElementById("add-guest-a").addEventListener('click', handleAdda);
      document.getElementById("update-guest-btn").addEventListener('click', handleUpdateGuest);
      document.getElementById("delete-guest-btn").addEventListener('click', handleDeleteGuest);
      document.getElementById("capnhat").addEventListener('click', handleUpdateRoomRent);

      //
      $('#update-guest-modal').on('show.bs.modal', function (event) {
		//get id
		const button = $(event.relatedTarget) 
		const id = button.data('id')
        console.log("id: " + id); 
		seletedGuest = guests.filter(g=>g.id == parseInt(id))[0];
		//get guest by id
		//code here
		//let guest = {};
        //console.log("seletedGuest: " + seletedGuest);
		// fill data
		const modal = $(this)
		modal.find('#update-guest-name').val(seletedGuest.fullname);
		modal.find("#update-type-select").val(seletedGuest.typeId);
		modal.find('#update-guest-id').val(seletedGuest.identityNumber);
		modal.find("#update-guest-address").val(seletedGuest.address);
	})

      $('#delete-guest-modal').on('show.bs.modal', function (event) {
				//get id
				const button = $(event.relatedTarget) 
				const id = button.data('id') 
				seletedGuestId = id;
			});

      document.getElementById("cur-room").innerText = "Phòng: " + room.roomId;
	  document.getElementById("time").innerText = `Ngày thuê: ${time[2]}/${time[1]}/${time[0]}`;
    })
	</script>
{{/section}}